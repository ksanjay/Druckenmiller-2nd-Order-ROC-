<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Druckenmiller ROC Model</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // --- ICONS ---
        const LineChart = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>;
        const ArrowUpCircle = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>;
        const ArrowDownCircle = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m16 12-4 4-4-4"/><path d="M12 8v8"/></svg>;
        const Activity = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>;
        const TrendingUp = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>;
        const AlertCircle = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
        const CheckCircle = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const Loader2 = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
        const Database = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>;
        const Shield = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>;

        // --- API CONFIGURATION ---
        const FMP_KEY = 'zZ5zECyopZEcPtKvkqlb1R52jv2vFusj';
        const ALPHAVANTAGE_KEY = 'JQQUUJQRAX8TLXSM'; 
        const FINNHUB_KEY = 'd22igc9r01qr7ajlkob0d22igc9r01qr7ajlkobg';
        
        // CORS Proxy to bypass browser security restrictions if direct calls fail
        const PROXY_URL = 'https://api.allorigins.win/raw?url=';

        // --- HELPER: ROBUST FETCH ---
        // Tries direct fetch first. If that fails (CORS/Network), tries via Proxy.
        const robustFetch = async (url, sourceName) => {
            try {
                // Attempt 1: Direct
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (directError) {
                console.warn(`${sourceName} Direct failed (${directError.message}). Trying Proxy...`);
                
                // Attempt 2: Via Proxy
                try {
                    const proxyResponse = await fetch(`${PROXY_URL}${encodeURIComponent(url)}`);
                    if (!proxyResponse.ok) throw new Error(`Proxy HTTP ${proxyResponse.status}`);
                    return await proxyResponse.json();
                } catch (proxyError) {
                    throw new Error(`${sourceName} Failed (Direct & Proxy): ${directError.message}`);
                }
            }
        };

        // --- DATA FETCHING STRATEGIES ---

        const fetchFMP = async (ticker) => {
            const url = `https://financialmodelingprep.com/api/v3/historical-price-full/${ticker}?apikey=${FMP_KEY}`;
            const data = await robustFetch(url, 'FMP');
            
            if (data['Error Message']) throw new Error("FMP API Error: Invalid Ticker or Key");
            if (!data.historical || data.historical.length === 0) throw new Error("FMP: No historical data");

            const historical = data.historical.reverse(); 
            const monthlyData = [];
            let currentMonth = null;

            historical.forEach((day, index) => {
                const date = new Date(day.date);
                const month = date.getFullYear() + '-' + date.getMonth();
                if (currentMonth !== null && currentMonth !== month) {
                    monthlyData.push({
                        rawDate: new Date(historical[index - 1].date),
                        date: new Date(historical[index - 1].date).toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
                        price: parseFloat(historical[index - 1].close)
                    });
                }
                currentMonth = month;
            });
            if (historical.length > 0) {
                 const last = historical[historical.length - 1];
                 monthlyData.push({
                    rawDate: new Date(last.date),
                    date: new Date(last.date).toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
                    price: parseFloat(last.close)
                });
            }
            return monthlyData;
        };

        const fetchAlphaVantage = async (ticker) => {
            const url = `https://www.alphavantage.co/query?function=TIME_SERIES_MONTHLY_ADJUSTED&symbol=${ticker}&apikey=${ALPHAVANTAGE_KEY}`;
            const data = await robustFetch(url, 'AlphaVantage');

            if (data['Note']) throw new Error("AlphaVantage: Rate Limit Reached");
            if (data['Error Message']) throw new Error("AlphaVantage: Invalid Ticker");
            if (!data['Monthly Adjusted Time Series']) throw new Error("AlphaVantage: No data");

            const timeSeries = data['Monthly Adjusted Time Series'];
            const formattedData = [];
            for (const [date, values] of Object.entries(timeSeries)) {
              formattedData.push({
                rawDate: new Date(date),
                date: new Date(date).toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
                price: parseFloat(values['5. adjusted close'])
              });
            }
            return formattedData;
        };

        const fetchFinnhub = async (ticker) => {
            const to = Math.floor(Date.now() / 1000);
            const from = to - (4 * 365 * 24 * 60 * 60); // 4 years
            const url = `https://finnhub.io/api/v1/stock/candle?symbol=${ticker}&resolution=M&from=${from}&to=${to}&token=${FINNHUB_KEY}`;
            const data = await robustFetch(url, 'Finnhub');
            
            if (data.s === 'no_data') throw new Error("Finnhub: No Data");
            if (data.error) throw new Error(`Finnhub: ${data.error}`);
            if (!data.c || !data.t) throw new Error("Finnhub: Invalid Format");

            return data.t.map((timestamp, index) => ({
                rawDate: new Date(timestamp * 1000),
                date: new Date(timestamp * 1000).toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
                price: parseFloat(data.c[index])
            }));
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
          const [ticker, setTicker] = useState('AMZN');
          const [inputTicker, setInputTicker] = useState('');
          const [marketData, setMarketData] = useState([]);
          const [metrics, setMetrics] = useState(null);
          const [category, setCategory] = useState('Tech');
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState(null);
          const [errorDetails, setErrorDetails] = useState([]);
          const [dataSource, setDataSource] = useState('');

          const loadData = async (symbol) => {
            setLoading(true);
            setError(null);
            setErrorDetails([]);
            setMarketData([]);
            setMetrics(null);
            setDataSource('');
            
            const failures = [];

            // 1. Try FMP (Direct or Proxy)
            try {
                const data = await fetchFMP(symbol);
                processData(data, 'FMP (Primary)');
                setLoading(false);
                return;
            } catch (e) {
                console.warn(e);
                failures.push(`FMP: ${e.message}`);
            }

            // 2. Try AlphaVantage (Direct or Proxy)
            try {
                const data = await fetchAlphaVantage(symbol);
                processData(data, 'AlphaVantage (Backup)');
                setLoading(false);
                return;
            } catch (e) {
                console.warn(e);
                failures.push(`AlphaVantage: ${e.message}`);
            }

            // 3. Try Finnhub (Direct or Proxy)
            try {
                const data = await fetchFinnhub(symbol);
                processData(data, 'Finnhub (Fallback)');
                setLoading(false);
                return;
            } catch (e) {
                console.warn(e);
                failures.push(`Finnhub: ${e.message}`);
            }

            // All Failed
            setError("All Data Providers Failed");
            setErrorDetails(failures);
            setLoading(false);
          };

          const processData = (data, source) => {
             const sorted = data.sort((a, b) => a.rawDate - b.rawDate).slice(-48);
             
             // Calculate Metrics
             const calculated = sorted.map((point, i) => {
                let roc1 = null, roc2 = null;
                if (i >= 3) {
                  const pastPrice = sorted[i - 3].price;
                  roc1 = ((point.price - pastPrice) / pastPrice) * 100;
                }
                if (i >= 4 && roc1 !== null) {
                  const prevRoc1 = ((sorted[i-1].price - sorted[i-4].price) / sorted[i-4].price) * 100;
                  roc2 = roc1 - prevRoc1;
                }
                return { ...point, roc1, roc2 };
             });

             setMarketData(calculated);
             setMetrics(calculated[calculated.length - 1]);
             setDataSource(source);
          };

          useEffect(() => { loadData(ticker); }, [ticker]);

          const handleSearch = (e) => {
            e.preventDefault();
            if (inputTicker.trim()) {
              setTicker(inputTicker.trim().toUpperCase());
              setInputTicker('');
            }
          };

          const getSignal = (roc2) => {
             if (roc2 === null) return { text: 'WAIT', color: 'gray' };
             if (roc2 >= 5) return { text: 'Strong Acceleration', color: 'green' };
             if (roc2 > 0) return { text: 'Accelerating', color: 'emerald' };
             if (roc2 <= -5) return { text: 'Strong Deceleration', color: 'red' };
             return { text: 'Decelerating', color: 'orange' };
          };

          const getRecommendation = (roc2) => {
             if (roc2 === null) return { text: "LOADING...", color: "text-gray-400", bg: "bg-gray-100", border: "border-gray-300" };
             if (roc2 > 0) return { text: "BUY", color: "text-green-700", bg: "bg-green-100", border: "border-green-500" };
             if (roc2 <= -5) return { text: "SELL", color: "text-red-600", bg: "bg-red-100", border: "border-red-500" };
             return { text: "HOLD", color: "text-[#8B4513]", bg: "bg-orange-50", border: "border-[#8B4513]" };
          };

          const currentSignal = metrics ? getSignal(metrics.roc2) : { text: 'Loading...', color: 'gray' };
          const recommendation = metrics ? getRecommendation(metrics.roc2) : getRecommendation(null);

          // --- CHART COMPONENT ---
          const ChartPanel = ({ data, title, color, yKey, zeroLine }) => {
            if (!data || data.length === 0) return null;
            const valid = data.filter(d => d[yKey] !== null);
            const width = 600, height = 150, padding = 20;
            const min = Math.min(...valid.map(d => d[yKey])), max = Math.max(...valid.map(d => d[yKey]));
            const range = max - min || 1;

            const points = valid.map((d, i) => {
               const x = padding + (i / (valid.length - 1)) * (width - 2 * padding);
               const y = height - padding - ((d[yKey] - min) / range) * (height - 2 * padding);
               return `${x},${y}`;
            }).join(' ');
            
            const zeroY = zeroLine ? height - padding - ((0 - min) / range) * (height - 2 * padding) : null;

            return (
              <div className="mb-6 bg-white rounded-lg shadow-sm border border-slate-200 p-4">
                 <div className="flex justify-between items-center mb-2"><h3 className="text-sm font-semibold text-slate-600 uppercase">{title}</h3></div>
                 <div className="relative w-full h-40">
                   <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible">
                      <line x1={padding} y1={padding} x2={padding} y2={height-padding} stroke="#e2e8f0" />
                      <line x1={padding} y1={height-padding} x2={width-padding} y2={height-padding} stroke="#e2e8f0" />
                      {zeroLine && <line x1={padding} y1={zeroY} x2={width-padding} y2={zeroY} stroke="#94a3b8" strokeDasharray="4 4" />}
                      
                      {/* Bars for 2nd ROC */}
                      {title.includes("Acceleration") && valid.map((d, i) => {
                         if (i===0) return null;
                         const x = padding + (i / (valid.length - 1)) * (width - 2 * padding);
                         const y = height - padding - ((d[yKey] - min) / range) * (height - 2 * padding);
                         const barH = Math.abs(y - zeroY);
                         return <rect key={i} x={x-2} y={d[yKey]>=0 ? y : zeroY} width={4} height={barH} fill={d[yKey]>=0?'#10b981':'#ef4444'} opacity="0.6" />;
                      })}

                      <polyline points={points} fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                   </svg>
                 </div>
                 <div className="flex justify-between text-xs text-slate-500 mt-2">
                    <span>{valid[0].date}</span>
                    <span className="font-bold text-slate-800">Current: {valid[valid.length-1][yKey].toFixed(2)}</span>
                    <span>{valid[valid.length-1].date}</span>
                 </div>
              </div>
            );
          };

          const SECTOR_PICKS = {
             'Tech': [
                { symbol: 'GOOGL', name: 'Alphabet Inc.', roc2: 6.2, signal: 'BUY' },
                { symbol: 'META', name: 'Meta Platforms', roc2: 8.4, signal: 'STRONG BUY' },
                { symbol: 'MSFT', name: 'Microsoft', roc2: 2.1, signal: 'BUY' },
             ],
             'Healthcare': [
                { symbol: 'NTRA', name: 'Natera Inc.', roc2: 12.5, signal: 'STRONG BUY' },
                { symbol: 'INSM', name: 'Insmed Inc.', roc2: 9.3, signal: 'STRONG BUY' },
             ]
          };

          return (
            <div className="min-h-screen bg-slate-50 font-sans text-slate-900">
               <header className="bg-slate-900 text-white p-6 shadow-lg">
                  <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center">
                     <div>
                        <h1 className="text-2xl font-bold flex items-center gap-2">
                           <TrendingUp className="text-emerald-400" /> Druckenmiller ROC II
                        </h1>
                        <p className="text-slate-400 text-sm mt-1">Live Data • FMP / AV / Finnhub</p>
                     </div>
                     <form onSubmit={handleSearch} className="flex gap-2 w-full md:w-auto mt-4 md:mt-0">
                        <input type="text" placeholder="Symbol (e.g. AMZN)" className="px-4 py-2 rounded bg-slate-800 border border-slate-700 text-white w-full" value={inputTicker} onChange={(e)=>setInputTicker(e.target.value)} />
                        <button type="submit" className="bg-emerald-600 px-6 py-2 rounded font-semibold">Analyze</button>
                     </form>
                  </div>
               </header>

               <main className="max-w-6xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
                  {/* Banner */}
                  <div className={`col-span-1 lg:col-span-3 rounded-xl p-4 text-center border-4 shadow-sm ${recommendation.bg} ${recommendation.border}`}>
                     <div className="text-sm font-bold text-slate-600 uppercase tracking-widest mb-1">RECOMMENDATION</div>
                     <div className={`text-5xl font-black tracking-wider ${recommendation.color}`}>
                        {error ? "ERROR" : (loading ? "LOADING..." : recommendation.text)}
                     </div>
                  </div>

                  {/* Left Col */}
                  <div className="lg:col-span-2 space-y-6">
                     {error ? (
                        <div className="bg-red-50 border-l-4 border-red-500 p-4">
                           <div className="flex items-center gap-2 text-red-700 font-bold mb-2">
                              <AlertCircle /> Connection Failed
                           </div>
                           <p className="text-sm text-red-600 mb-4">We tried all 3 data providers. Both direct and proxy connections failed.</p>
                           <ul className="list-disc pl-5 text-xs text-red-500 space-y-1 mb-4">
                              {errorDetails.map((msg, i) => <li key={i}>{msg}</li>)}
                           </ul>
                           <button onClick={() => loadData(ticker)} className="bg-red-100 hover:bg-red-200 text-red-800 px-4 py-2 rounded text-sm font-semibold transition">
                              Retry Connection
                           </button>
                        </div>
                     ) : (
                        <div className="bg-white rounded-xl shadow-md overflow-hidden border-l-8" style={{ borderLeftColor: currentSignal.color === 'green' || currentSignal.color === 'emerald' ? '#10b981' : '#ef4444' }}>
                           <div className="p-6 flex justify-between items-center">
                              <div>
                                 <h2 className="text-3xl font-bold text-slate-800">{ticker.toUpperCase()}</h2>
                                 <div className="flex items-center gap-2 mt-1">
                                    <span className="text-slate-500 text-sm">3-Month Momentum</span>
                                    {dataSource && (
                                       <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold uppercase ${dataSource.includes('FMP') ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}`}>
                                          Source: {dataSource}
                                          <Shield size={10} className="inline ml-1 mb-0.5" />
                                       </span>
                                    )}
                                 </div>
                              </div>
                              <div className="text-right">
                                 <div className="text-sm font-bold uppercase tracking-widest text-slate-500">Signal</div>
                                 <div className={`text-2xl font-bold text-${currentSignal.color}-600`}>{currentSignal.text}</div>
                              </div>
                           </div>
                           {/* Metrics */}
                           {metrics && (
                             <div className="bg-slate-50 px-6 py-4 grid grid-cols-3 gap-4 border-t border-slate-100">
                               <div><div className="text-xs text-slate-500 uppercase font-semibold">Price</div><div className="text-xl font-bold">${metrics.price.toFixed(2)}</div></div>
                               <div><div className="text-xs text-slate-500 uppercase font-semibold">Velocity</div><div className="text-xl font-bold">{metrics.roc1.toFixed(2)}%</div></div>
                               <div><div className="text-xs text-slate-500 uppercase font-semibold">Acceleration</div><div className="text-xl font-bold">{metrics.roc2.toFixed(2)}</div></div>
                             </div>
                           )}
                        </div>
                     )}

                     {!error && !loading && (
                        <div className="space-y-4">
                           <ChartPanel data={marketData} title="Price Action" color="#334155" yKey="price" />
                           <ChartPanel data={marketData} title="Velocity (ROC)" color="#3b82f6" yKey="roc1" zeroLine={true} />
                           <ChartPanel data={marketData} title="Acceleration (2nd ROC)" color="#8b5cf6" yKey="roc2" zeroLine={true} />
                        </div>
                     )}
                  </div>

                  {/* Right Col */}
                  <div className="lg:col-span-1">
                     <div className="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                        <div className="bg-slate-50 p-4 border-b border-slate-200">
                           <h3 className="font-bold text-slate-800 flex items-center gap-2"><CheckCircle size={18} className="text-emerald-600"/> Top Picks</h3>
                        </div>
                        <div className="divide-y divide-slate-100">
                           {SECTOR_PICKS[category].map(s => (
                              <div key={s.symbol} onClick={()=>setTicker(s.symbol)} className="p-4 hover:bg-slate-50 cursor-pointer flex justify-between items-center">
                                 <div><div className="font-bold text-slate-900">{s.symbol}</div><div className="text-xs text-slate-500">{s.name}</div></div>
                                 <div className="text-right"><div className="text-[10px] font-bold bg-green-100 text-green-700 px-2 py-1 rounded">{s.signal}</div><div className="text-xs font-mono text-emerald-600 mt-1">+{s.roc2}</div></div>
                              </div>
                           ))}
                        </div>
                     </div>
                     {/* Data Source Info Card */}
                     <div className="mt-4 bg-slate-100 border border-slate-200 rounded-lg p-3 text-xs text-slate-500 flex items-start gap-2">
                         <Database size={14} className="shrink-0 mt-0.5" />
                         <p>
                             Strategy: FMP (Primary) → AlphaVantage → Finnhub. Uses CORS Proxy if direct connection is blocked by browser.
                         </p>
                    </div>
                  </div>
               </main>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
